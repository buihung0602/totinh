<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MANGA ADMIN DEMO ‚Äî Tr√¨nh ƒë·ªçc truy·ªán ph√¢n quy·ªÅn</title>
  <style>
    :root{--bg:#f4f7fb;--card:#fff;--muted:#6b7280;--accent:#1e90ff}
    [data-theme='dark']{--bg:#0b0e14;--card:#0f1720;--muted:#9aa4b2;--accent:#6ea8ff;color:#e6eef9}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:inherit}
    header{background:var(--card);padding:12px 16px;display:flex;align-items:center;gap:12px;position:sticky;top:0;z-index:30}
    header h1{margin:0;font-size:18px}
    header .right{margin-left:auto;display:flex;gap:8px;align-items:center}
    .container{max-width:1200px;margin:16px auto;padding:12px}
    .grid{display:grid;grid-template-columns:300px 1fr;gap:16px}
    .card{background:var(--card);padding:12px;border-radius:10px;box-shadow:0 1px 4px rgba(0,0,0,.04)}
    .comic-item{display:flex;gap:10px;padding:8px;border-radius:8px;cursor:pointer;align-items:center}
    .comic-item img{width:56px;height:80px;object-fit:cover;border-radius:6px}
    .meta small{color:var(--muted)}
    .toolbar{display:flex;gap:8px;align-items:center;margin-bottom:12px}

    .reader .page img{width:100%;height:auto;border-radius:8px}
    .chapter-list{display:flex;flex-wrap:wrap;gap:8px}
    .btn{padding:8px 10px;border-radius:8px;border:1px solid #ddd;background:transparent;cursor:pointer}
    .btn-primary{background:var(--accent);color:white;border:none}
    .danger{background:#ffd6d6;border-color:#ff9e9e}
    .form-row{display:flex;gap:8px;align-items:center}
    input[type='text'],textarea,select{padding:8px;border-radius:8px;border:1px solid #ddd;width:100%}
    label{font-size:13px;color:var(--muted)}
    .small{font-size:13px;color:var(--muted)}
    footer{padding:12px;text-align:center;color:var(--muted);font-size:13px}
    @media(max-width:880px){.grid{grid-template-columns:1fr} .comic-item img{width:48px;height:68px}}
    .hidden{display:none}
    .audit{font-size:13px}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#eef;font-size:12px}
  </style>
</head>
<body>
  <header>
    <h1>MANGA ‚Äî DEMO (Admin/User)</h1>
    <div class="right">
      <div id="who" class="small">Ch∆∞a ƒëƒÉng nh·∫≠p</div>
      <button id="toggleTheme" class="btn" title="Toggle theme">üåô</button>
      <button id="loginBtn" class="btn btn-primary">ƒêƒÉng nh·∫≠p</button>
      <button id="logoutBtn" class="btn hidden">ƒêƒÉng xu·∫•t</button>
    </div>
  </header>

  <div class="container">
    <div class="grid">
      <aside class="card">
        <div class="toolbar">
          <input id="search" placeholder="T√¨m truy·ªán..." />
          <button id="newComicBtn" class="btn btn-primary hidden">‚ûï Th√™m</button>
        </div>
        <div id="comicList"></div>
        <hr>
        <div>
          <h4>Bookmark</h4>
          <div id="bookmarks" class="small"></div>
        </div>
      </aside>

      <main>
        <section id="readerSection" class="card reader">
          <div class="toolbar">
            <select id="chapterSelect"></select>
            <button id="prevChap" class="btn">‚¨Ö</button>
            <button id="nextChap" class="btn">‚û°</button>
            <button id="toggleContinuous" class="btn">Toggle Continuous</button>
            <button id="bookmarkBtn" class="btn">üîñ L∆∞u bookmark</button>
            <div style="margin-left:auto"><span id="roleBadge" class="pill">GUEST</span></div>
          </div>

          <div id="viewer" tabindex="0"></div>
        </section>

        <section id="adminPanel" class="card hidden" style="margin-top:12px">
          <h3>Admin Panel</h3>
          <div style="display:flex;gap:12px">
            <div style="flex:1">
              <h4>Chi ti·∫øt truy·ªán</h4>
              <div class="form-row"><input id="comicTitle" placeholder="Ti√™u ƒë·ªÅ" /></div>
              <div class="form-row" style="margin-top:8px"><input id="comicAuthor" placeholder="T√°c gi·∫£" /></div>
              <div class="form-row" style="margin-top:8px"><input id="comicThumb" placeholder="URL thumbnail" /></div>
              <div style="margin-top:8px;display:flex;gap:6px"><button id="saveComic" class="btn btn-primary">L∆∞u</button><button id="deleteComic" class="btn danger">X√≥a</button></div>
            </div>
            <div style="width:380px">
              <h4>Chapters</h4>
              <div id="chapterEditor">
                <div class="form-row"><input id="chapTitle" placeholder="Ti√™u ƒë·ªÅ chap" /></div>
                <div class="form-row" style="margin-top:8px"><input id="imgUrlInput" placeholder="URL ·∫£nh (ho·∫∑c ch·ªçn file)" /></div>
                <div style="margin-top:8px;display:flex;gap:6px"><input id="imgFile" type="file" accept="image/*" /><button id="addImgBtn" class="btn">Th√™m ·∫£nh</button></div>
                <div style="margin-top:8px;display:flex;gap:6px"><button id="createChapBtn" class="btn btn-primary">T·∫°o chap m·ªõi</button><button id="deleteChapBtn" class="btn danger">X√≥a chap</button></div>
                <div style="margin-top:12px"><strong>·∫¢nh trong chap hi·ªán t·∫°i</strong><div id="imgList"></div></div>
              </div>
            </div>
          </div>

          <hr>
          <div>
            <h4>Audit logs</h4>
            <div id="auditLogs" class="audit" style="max-height:180px;overflow:auto"></div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <footer>Demo local ‚Äî to√†n b·ªô d·ªØ li·ªáu l∆∞u trong <code>localStorage</code>. ƒê·ªÉ production c·∫ßn backend + database.</footer>

  <template id="comicTpl">
    <div class="comic-item">
      <img src="" alt="thumb" />
      <div class="meta"><b class="title"></b><div class="small author"></div></div>
    </div>
  </template>

  <script>
  // -------------------- STORAGE KEYS --------------------
  const STORE_KEY = 'manga-app-store-v1';
  const USER_KEY = 'manga-app-users-v1';
  const AUDIT_KEY = 'manga-app-audit-v1';

  // -------------------- SAMPLE USERS --------------------
  // For demo only. Passwords are plain text here. In production use server + hashing.
  const DEFAULT_USERS = [
    {id:1, name:'admin', password:'123', role:'admin'},
    {id:2, name:'user', password:'123', role:'user'}
  ];

  // -------------------- DEFAULT DATA --------------------
  const SAMPLE_COMICS = [
    {
      id:'demo-1', title:'Demo Truy·ªán 1', author:'T√°c gi·∫£ A', thumb:'https://placehold.co/200x300?text=Demo1',
      chapters:[{id:'d1-c1', title:'Chap 1', images:['https://placehold.co/1000x1400?text=1-1','https://placehold.co/1000x1400?text=1-2']},
                {id:'d1-c2', title:'Chap 2', images:['https://placehold.co/1000x1400?text=2-1']}]
    },
    {id:'demo-2', title:'Demo Truy·ªán 2', author:'T√°c gi·∫£ B', thumb:'https://placehold.co/200x300?text=Demo2', chapters:[]}
  ];

  // -------------------- STATE --------------------
  let state = { users:[], comics:[], currentUser:null, currentComicId:null, currentChapIndex:0, continuous:true };

  // -------------------- UTIL --------------------
  function uid(prefix='id'){return prefix + '-' + Math.random().toString(36).slice(2,9)}
  function now(){return new Date().toISOString()}
  function saveState(){ localStorage.setItem(STORE_KEY, JSON.stringify(state)); }
  function loadState(){
    const raw = localStorage.getItem(STORE_KEY);
    const uraw = localStorage.getItem(USER_KEY);
    if(uraw){ state.users = JSON.parse(uraw); }
    else{ state.users = DEFAULT_USERS; localStorage.setItem(USER_KEY, JSON.stringify(DEFAULT_USERS)); }
    if(raw){ try{ const s = JSON.parse(raw); Object.assign(state,s); }catch(e){ console.error(e); } }
    if(!state.comics || state.comics.length===0){ state.comics = SAMPLE_COMICS; saveState(); }
  }

  function pushAudit(action, details){
    const logs = JSON.parse(localStorage.getItem(AUDIT_KEY) || '[]');
    logs.unshift({id:uid('log'), action, details, by: state.currentUser ? state.currentUser.name : 'guest', at: now()});
    localStorage.setItem(AUDIT_KEY, JSON.stringify(logs.slice(0,200)));
    renderAudit();
  }

  // -------------------- AUTH --------------------
  function loginPrompt(){
    const name = prompt('T√†i kho·∫£n (admin/user):');
    if(!name) return;
    const pwd = prompt('M·∫≠t kh·∫©u:');
    const user = state.users.find(u=>u.name===name && u.password===pwd);
    if(!user) return alert('ƒêƒÉng nh·∫≠p th·∫•t b·∫°i');
    state.currentUser = {id:user.id,name:user.name,role:user.role}; saveState(); renderAuth(); pushAudit('login', {user:user.name});
  }
  function logout(){ pushAudit('logout',{}); state.currentUser = null; saveState(); renderAuth(); }

  // -------------------- RENDER UI --------------------
  const comicListEl = document.getElementById('comicList');
  const comicTpl = document.getElementById('comicTpl');
  const whoEl = document.getElementById('who');
  const loginBtn = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const newComicBtn = document.getElementById('newComicBtn');
  const adminPanel = document.getElementById('adminPanel');
  const viewer = document.getElementById('viewer');
  const chapterSelect = document.getElementById('chapterSelect');
  const roleBadge = document.getElementById('roleBadge');

  function renderComics(filter=''){
    comicListEl.innerHTML='';
    state.comics.filter(c=> (c.title + ' ' + c.author).toLowerCase().includes(filter.toLowerCase())).forEach(c=>{
      const frag = comicTpl.content.cloneNode(true);
      frag.querySelector('img').src = c.thumb || 'https://placehold.co/120x180';
      frag.querySelector('.title').textContent = c.title;
      frag.querySelector('.author').textContent = c.author || '';
      const node = frag.firstElementChild;
      node.addEventListener('click', ()=> selectComic(c.id));
      comicListEl.appendChild(node);
    });
  }

  function renderAuth(){
    if(state.currentUser){ whoEl.textContent = `ƒêƒÉng nh·∫≠p v·ªõi ${state.currentUser.name}`; loginBtn.classList.add('hidden'); logoutBtn.classList.remove('hidden'); roleBadge.textContent = state.currentUser.role.toUpperCase(); }
    else{ whoEl.textContent='Ch∆∞a ƒëƒÉng nh·∫≠p'; loginBtn.classList.remove('hidden'); logoutBtn.classList.add('hidden'); roleBadge.textContent='GUEST'; }
    // show admin UI
    if(state.currentUser && state.currentUser.role === 'admin'){
      adminPanel.classList.remove('hidden'); newComicBtn.classList.remove('hidden'); document.getElementById('saveComic').classList.remove('hidden');
    }else{ adminPanel.classList.add('hidden'); newComicBtn.classList.add('hidden'); }
    renderBookmarks(); renderComics(document.getElementById('search').value || '');
  }

  function selectComic(id){ state.currentComicId = id; state.currentChapIndex = 0; saveState(); renderSelected(); }
  function renderSelected(){
    const c = state.comics.find(x=>x.id===state.currentComicId);
    if(!c){ viewer.innerHTML = '<div class="small">Ch∆∞a ch·ªçn truy·ªán</div>'; chapterSelect.innerHTML=''; return; }
    // chapters
    chapterSelect.innerHTML=''; c.chapters.forEach((ch,i)=>{ const opt = document.createElement('option'); opt.value=i; opt.textContent = ch.title; chapterSelect.appendChild(opt); });
    chapterSelect.value = state.currentChapIndex;
    showChapter(state.currentChapIndex);
    // fill admin form
    document.getElementById('comicTitle').value = c.title || '';
    document.getElementById('comicAuthor').value = c.author || '';
    document.getElementById('comicThumb').value = c.thumb || '';
    renderImgList();
  }

  function showChapter(idx){ const c = state.comics.find(x=>x.id===state.currentComicId); if(!c) return; const chap = c.chapters[idx]; if(!chap) return; viewer.innerHTML=''; if(state.continuous){ chap.images.forEach(src=>{ const d = document.createElement('div'); d.className='page'; const img = document.createElement('img'); img.src = src; img.loading='lazy'; d.appendChild(img); viewer.appendChild(d); }); } else { const src = chap.images[0] || ''; viewer.innerHTML = src ? `<div class="page"><img src="${src}" loading="lazy" /></div>` : '<div class="small">Kh√¥ng c√≥ ·∫£nh</div>'; } }

  // -------------------- CRUD ADMIN --------------------
  function createNewComic(){
    const id = uid('comic'); const title = prompt('Ti√™u ƒë·ªÅ truy·ªán:') || 'Untitled';
    const newC = {id, title, author:'', thumb:'https://placehold.co/200x300?text=new', chapters:[]};
    state.comics.unshift(newC); saveState(); pushAudit('create:comic',{comic:newC}); renderComics(); selectComic(id);
  }

  function saveComic(){ const c = state.comics.find(x=>x.id===state.currentComicId); if(!c) return alert('Ch∆∞a ch·ªçn truy·ªán'); const before=JSON.parse(JSON.stringify(c)); c.title = document.getElementById('comicTitle').value; c.author = document.getElementById('comicAuthor').value; c.thumb = document.getElementById('comicThumb').value; saveState(); pushAudit('update:comic',{before,after:c}); renderComics(); alert('L∆∞u th√†nh c√¥ng'); }

  function deleteComic(){ if(!confirm('X√°c nh·∫≠n x√≥a truy·ªán?')) return; const idx = state.comics.findIndex(x=>x.id===state.currentComicId); if(idx===-1) return; const before = state.comics[idx]; state.comics.splice(idx,1); state.currentComicId=null; saveState(); pushAudit('delete:comic',{before}); renderComics(); renderSelected(); }

  // Chapters
  function createChap(){ const c = state.comics.find(x=>x.id===state.currentComicId); if(!c) return alert('Ch∆∞a ch·ªçn truy·ªán'); const title = document.getElementById('chapTitle').value || ('Chap ' + (c.chapters.length+1)); const chap = {id:uid('chap'), title, images:[]}; c.chapters.push(chap); saveState(); pushAudit('create:chap',{comic:c.id, chap}); renderSelected(); alert('T·∫°o chap xong. Th√™m ·∫£nh v√†o chap qua input.'); }
  function deleteChap(){ const c = state.comics.find(x=>x.id===state.currentComicId); if(!c) return; const idx = Number(chapterSelect.value); if(isNaN(idx)) return; if(!confirm('X√≥a chap?')) return; const before = c.chapters[idx]; c.chapters.splice(idx,1); state.currentChapIndex = Math.max(0, state.currentChapIndex-1); saveState(); pushAudit('delete:chap',{comic:c.id, before}); renderSelected(); }

  // Images add: by URL or file
  function addImageToCurrent(url){ const c = state.comics.find(x=>x.id===state.currentComicId); if(!c) return; const chap = c.chapters[state.currentChapIndex]; if(!chap) return alert('Ch∆∞a ch·ªçn chap'); chap.images.push(url); saveState(); pushAudit('add:image',{comic:c.id, chap:chap.id, url}); renderImgList(); showChapter(state.currentChapIndex); }

  function handleFileToDataUrl(file, cb){ const fr = new FileReader(); fr.onload = ()=> cb(fr.result); fr.readAsDataURL(file); }

  function renderImgList(){ const el = document.getElementById('imgList'); el.innerHTML=''; const c = state.comics.find(x=>x.id===state.currentComicId); if(!c) return; const chap = c.chapters[state.currentChapIndex]; if(!chap) return; chap.images.forEach((src,i)=>{ const div = document.createElement('div'); div.style.display='flex'; div.style.alignItems='center'; div.style.gap='8px'; div.style.padding='6px 0'; div.innerHTML = `<img src="${src}" style="width:60px;height:80px;object-fit:cover;border-radius:6px"/><div style="flex:1"><div style=\"font-size:13px\">${src.split('?')[0].slice(0,60)}</div><div class=\"small\">#${i+1}</div></div><div><button data-i="${i}" class=\"btn\">X√≥a</button></div>`; el.appendChild(div); div.querySelector('button').addEventListener('click', ()=>{ if(!confirm('X√≥a ·∫£nh?')) return; const removed = chap.images.splice(i,1); saveState(); pushAudit('delete:image',{comic:c.id, chap:chap.id, removed}); renderImgList(); showChapter(state.currentChapIndex); }); }); }

  // -------------------- BOOKMARK --------------------
  function saveBookmark(){ if(!state.currentComicId) return alert('Ch∆∞a ch·ªçn truy·ªán'); const b = JSON.parse(localStorage.getItem('manga-bookmarks-v1')||'[]'); const entry = {comicId:state.currentComicId, chapIndex:state.currentChapIndex, at:now()}; b.unshift(entry); localStorage.setItem('manga-bookmarks-v1', JSON.stringify(b.slice(0,30))); renderBookmarks(); alert('ƒê√£ l∆∞u bookmark'); }
  function renderBookmarks(){ const node = document.getElementById('bookmarks'); node.innerHTML=''; const b = JSON.parse(localStorage.getItem('manga-bookmarks-v1')||'[]'); b.forEach(it=>{ const c = state.comics.find(x=>x.id===it.comicId); if(!c) return; const el = document.createElement('div'); el.style.padding='6px 0'; el.innerHTML = `<b>${c.title}</b> - ${c.chapIndex !== undefined ? c.chapters[it.chapIndex] ? c.chapters[it.chapIndex].title : '' : ''} <button style="float:right" class="btn">M·ªü</button>`; el.querySelector('button').addEventListener('click', ()=>{ state.currentComicId = it.comicId; state.currentChapIndex = it.chapIndex || 0; saveState(); renderSelected(); }); node.appendChild(el); }); }

  // -------------------- AUDIT --------------------
  function renderAudit(){ const node = document.getElementById('auditLogs'); const logs = JSON.parse(localStorage.getItem(AUDIT_KEY)||'[]'); node.innerHTML = logs.map(l=>`<div style="padding:6px;border-bottom:1px solid #eee"><b>${l.action}</b> b·ªüi <i>${l.by}</i> l√∫c ${l.at}<div style="font-size:13px;color:#444">${JSON.stringify(l.details)}</div></div>`).join(''); }

  // -------------------- EVENTS --------------------
  document.getElementById('search').addEventListener('input', e=> renderComics(e.target.value));
  document.getElementById('loginBtn').addEventListener('click', loginPrompt);
  document.getElementById('logoutBtn').addEventListener('click', ()=>{ logout(); });
  document.getElementById('newComicBtn').addEventListener('click', createNewComic);
  document.getElementById('saveComic').addEventListener('click', saveComic);
  document.getElementById('deleteComic').addEventListener('click', deleteComic);
  document.getElementById('createChapBtn').addEventListener('click', createChap);
  document.getElementById('deleteChapBtn').addEventListener('click', deleteChap);
  document.getElementById('addImgBtn').addEventListener('click', ()=>{
    const url = document.getElementById('imgUrlInput').value.trim(); const fileEl = document.getElementById('imgFile');
    if(url){ addImageToCurrent(url); document.getElementById('imgUrlInput').value=''; return; }
    if(fileEl.files && fileEl.files[0]){ handleFileToDataUrl(fileEl.files[0], dataUrl=>{ addImageToCurrent(dataUrl); fileEl.value=''; }); return; }
    alert('D√°n URL ho·∫∑c ch·ªçn file ·∫£nh');
  });

  document.getElementById('bookmarkBtn').addEventListener('click', saveBookmark);
  document.getElementById('chapterSelect').addEventListener('change', e=>{ state.currentChapIndex = Number(e.target.value); saveState(); showChapter(state.currentChapIndex); });
  document.getElementById('prevChap').addEventListener('click', ()=>{ const c = state.comics.find(x=>x.id===state.currentComicId); if(!c) return; if(state.currentChapIndex>0){ state.currentChapIndex--; saveState(); showChapter(state.currentChapIndex); chapterSelect.value = state.currentChapIndex; } });
  document.getElementById('nextChap').addEventListener('click', ()=>{ const c = state.comics.find(x=>x.id===state.currentComicId); if(!c) return; if(state.currentChapIndex < c.chapters.length-1){ state.currentChapIndex++; saveState(); showChapter(state.currentChapIndex); chapterSelect.value = state.currentChapIndex; } });
  document.getElementById('toggleTheme').addEventListener('click', ()=>{ const t = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'; if(t==='dark'){ document.documentElement.setAttribute('data-theme','dark'); } else { document.documentElement.removeAttribute('data-theme'); } });
  document.getElementById('toggleContinuous').addEventListener('click', ()=>{ state.continuous = !state.continuous; saveState(); showChapter(state.currentChapIndex); });

  // keyboard shortcuts
  document.addEventListener('keydown', e=>{ if(e.key==='ArrowLeft') document.getElementById('prevChap').click(); if(e.key==='ArrowRight') document.getElementById('nextChap').click(); if(e.key.toLowerCase()==='s') saveBookmark(); });

  // init
  loadState(); renderComics(); renderAuth(); renderAudit(); renderSelected();

  // helpful hint for first-time users
  if(!localStorage.getItem('seen-manga-demo-msg')){ alert('Demo: d√πng t√†i kho·∫£n admin/123 ho·∫∑c user/123. Admin c√≥ quy·ªÅn CRUD. To√†n b·ªô d·ªØ li·ªáu ch·ªâ l∆∞u tr√™n tr√¨nh duy·ªát.'); localStorage.setItem('seen-manga-demo-msg','1'); }
  </script>
</body>
</html>